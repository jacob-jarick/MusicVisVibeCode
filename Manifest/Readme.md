# About

This is my plain english description, this file will remain simple and high level.

manifest.md will serve as detailed agent guide.

# Agent Notes

## Planning

always read from updated Readme.md files and ensure Manifest.md file in same directory matches scope and direction outlined in Readme.md

## Adding New Visualization

1. Look at the vis Readme.md
2. Generate Manifest.md
3. Add Vis to CLI option --vis 
4. Ensure Vis is in Diable Menu

## Building 

always rebuild on code updates

always use CMake found here "C:\Program Files\CMake\bin;" 

never use cmake or any tools under "C:\Strawberry"

## testing

for testing we have a way (run exe with --help ) to run a specific visualisation.
You should do this for each build, to ensure the build runs and doesnt just crash after 2-5 seconds.

Ensure you test the newly added vis, use its name eg linefader and not its number which you sometimes mix up.

ensure you run with the timeout option

# Project Folders and Files

- Backgrounds: collection of images that can be used as visualization backgrounds.
- Manifest: Markdown files which serve as agent prompts.
- Manifest/Readme.md: this file, purely jacobs notes
- Manifest/Manifest.md: agent derived specs from Manifest/Readme.md
- Manifest/Visualizations: holds a directory for each visualization
- Manifest/Visualizations/Spectrum: my first vis.
- src: actual code generated by agent.

# High level overview

## Technology

Language: C++

Audio: WASAPI for sniffing current audio

Display: DirectX

## Architecure

### Audio Analyzing Engine

Samples audio 60 times a second

Parent Process/ co-process, starts first. Should have a simple console for debug info.

exposes an extremely simple set of structs visualisers can call for.

Each History array is a circular buffer, latest tracked with index, dont shift each item but instead use an index to know where to start in the array.

- boolean playing; simply shows if any audio playback is detected. useful for short circuiting further work by visualizer.
- float Spectrum[256]; an array of the spectrum values with values from 0-1 only
- float History[60][256]; the last 60 values of "Spectrum" 0 History[0] being most recent, History[60] being oldest
- float Scale; value: 0-1 tracks volume scale to allow normalizing Spectrum
- float SpectrumNormalized[256]; **Spectrum** but normalized using **Scale**
- float HistoryNormalized[60][256]; **History** but normalized using **Scale**
- float SpectrumHighestSample[256]; for each frequency (0-255) look at most the 6 most recent values in **HistoryNormalized** and use highest value. 

Most Visualizations I expect will only ever need to reference or **SpectrumNormalized** or **SpectrumHighestSample** 

if no audio for last 3 seconds set **playing**=false, if audio set **playing**=true

#### Scaling 

"Dynamic Scaling (AGC) Logic: The Scale variable acts as the global normalization ceiling for all spectrum data.

**Expansion (Immediate):**

On every audio update, if any value in the raw Spectrum array exceeds the current Scale, immediately set Scale to that new peak value. This prevents clipping.

**Contraction (Gradual):**

If the maximum value of the current Spectrum is less than the current Scale, reduce Scale by 5% per second (calculated using DeltaTime). This ensures that during quiet passages, the sensitivity increases until the bars fill the screen again.

**Floor:**

Define a MIN_SCALE (e.g., 0.001) to prevent the scale from dropping to zero during absolute silence, which would cause infinite spikes or "noise" flickers."

**Ceiling:**

set to 1.5x see code notes below

```c++
// Cap Scale at 1.5 (which means minimum peak of 1.0/1.5 = 0.667)
if (currentPeak < 0.667f) currentPeak = 0.667f;
```

## Visualization Engine

each visualization will have its own directory 

```
C:\git\MusicVisVibeCode\Manifest\Visualizations\Spectrum
```

In that directory will be

- Readme.md: my high level, used to generate Manifest.md
- Manifest.md: agents refined specs which it derive from the vis Readme.md which I will review when needed and agent will use to create the vis. 

Visualizations will be ordered by name

### Vis Background

Select randomly 1 picture from background folder and use as vis background (draw over image)

Image should be smoothly zoomed so no top / bottom or left and right black bars.
Do not stretch but scale and crop as neccessary

If a background is available, start with random background displayed always.

## Controls

Visualizations will have their own controls in addition to the main controls shown. they should never conflict with main controls.

help menu should also show vis specific controls. put a blank line then Vis Controls then vis contol details eg

```
Main:
h - Help
b - background


Current Vis:
x - example binding
```

- h: shows all keyboard shortcuts as an overlay (hide info screen if showing)
- 1,2,3,4,5,6,7,8,9,0: go to visualization on index X immediately. If we only have 3 vis numbers 4-0 auto clamp to 3. 0 is treated as 10. if more than 10 visualizations we still only map the first 10. Arrow keys can be used to select the next.
- left arrow: previous vis, if none (just started, do nothing), if only 1 vis do nothing.
- right arrow: next vis, if at last vis, loop back to start. if only 1 vis do nothing.
- r: select random vis.
- i: info, current visualization name and index, current **Scale** Value, FPS (hides help screen if showing)
- n: toggle using normalized or raw values for visualization (TODO remove)
- f: toggle fullescreen
- b: change background randomly, but ensure we dont use the current one again. (dont go to black)
- [: previous background (wrap dir listing)
- ]: next backhround (wrap dir listing) 
- c: show clock
- d: Bring up disable menu, shows list of current visualizations with number next to them. pressing its number toggles enabled/disabled. THis will remove the vis from the selection and rotation.
- r: reset all settings to defaults

## Config

Every N seconds, if config has changed sync to config file in users homedir in a dir named .musicvibecode

config should store all main and visulization settings.

## Display

Single resizable window

starts with first available 

# OSD Notes

OSD display should be placed top right. Put slightly tinted transparent box behind fonts so easier to read.

## Clock

yes a clock

Digital style clock, placed top right over visualisations etc

Display:

```
HH:MM:SS
DD/MM/YYYY
Day Of Week
```

clock should be right alined.

Clock font should be large.

Clock background:

Tinted box behind clock to make font more legible.
Tint should be black ~50% transparency.
Background box should be just 20% wider and taller than clock text.

Clock should be its own box and font size and not shared with Info and Help OSD

